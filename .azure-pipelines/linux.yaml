trigger:
  branches:
    include:
    - 'master'

jobs:
- job: bazel
  strategy:
    maxParallel: 3
    matrix:
      gcc:
        CI_TARGET: 'bazel.gcc'
      dev:
        CI_TARGET: 'bazel.dev'
      release:
        CI_TARGET: 'bazel.release'
  timeoutInMinutes: 360
  pool:
    vmImage: 'Ubuntu 16.04'
  steps:
  - bash: |
      sudo mkdir -p /etc/docker
      echo '{
        "ipv6": true,
        "fixed-cidr-v6": "2001:db8:1::/64"
      }' | sudo tee /etc/docker/daemon.json
      sudo service docker restart
    displayName: "Enable IPv6"

  - script: envoy/ci/run_envoy_docker.sh 'envoy/ci/do_ci.sh $(CI_TARGET) //test/common/... //test/extensions/...'
    env:
      ENVOY_BUILD_TARGET: "//:envoy"
      ENVOY_SRCDIR: "/source/envoy"
      BAZEL_BUILD_EXTRA_OPTIONS: "--curses=no"
    displayName: "Run CI script"
