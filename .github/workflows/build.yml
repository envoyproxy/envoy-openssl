name: Build

on:
  push:
    branches: [ "*" ]
  pull_request:
    branches: [ "main" ]

jobs:

  build:
    runs-on: ubuntu-20.04

    steps:

    - name: Checkout
      uses: actions/checkout@v3
      with:
        submodules: 'true'

    - name: SSH
      uses: lhotari/action-upterm@v1

    - name: Prerequisites
      run: sudo apt update -y && sudo apt install -y libclang-11-dev kcov

    - name: Configure
      run: cmake -B ${{github.workspace}}/build -S ${{github.workspace}}/bssl-compat -DCMAKE_BUILD_TYPE=RelWithDebInfo

    - name: Build
      run: cmake --build ${{github.workspace}}/build --config RelWithDebInfo

    - name: Test
      env:
        OPENSSL_CONF: ${{github.workspace}}/bssl-compat/source/test/openssl.cnf
      run: ctest --test-dir ${{github.workspace}}/build --output-junit ${{github.workspace}}/build/results.xml

    - name: Test Results
      uses: EnricoMi/publish-unit-test-result-action@v2
      if: always()
      with:
        junit_files: "${{github.workspace}}/build/results.xml"

    - name: Test Coverage
      env:
        OPENSSL_CONF: ${{github.workspace}}/bssl-compat/source/test/openssl.cnf
        LD_LIBRARY_PATH: ${{github.workspace}}/build/openssl/install/lib/:${{env.LD_LIBRARY_PATH}}
      run: kcov --exclude-pattern=/usr/include/,/_deps/,_test.,/test_,_test_ ${{github.workspace}}/build/kcov ${{github.workspace}}/build/utests-bssl-compat --gtest_output=xml:${{github.workspace}}/build/results.xml

    - name: Coverage Results
      uses: actions/upload-artifact@v3
      with:
        name: coverage-results
        path: ${{github.workspace}}/build/kcov/**
